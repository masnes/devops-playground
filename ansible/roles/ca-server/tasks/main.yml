---
# Install binaries
- name: "Get Smallstep"
  get_url:
    dest: "~{{ansible_user}}/step-certificates_0.13.3_amd64.deb"
    url: "https://github.com/smallstep/certificates/releases/download/v0.13.3/step-certificates_0.13.3_amd64.deb"
- name: "Get Smallstep CLI"
  get_url:
    dest: "~{{ansible_user}}/step-cli_0.13.3_amd64.deb"
    url: "https://github.com/smallstep/cli/releases/download/v0.13.3/step-cli_0.13.3_amd64.deb"
- name: Install smallstep and smallstep cli
  become: true
  apt:
    deb:  "~{{ansible_user}}/{{item}}"
  with_items:
    - "step-certificates_0.13.3_amd64.deb"
    - "step-cli_0.13.3_amd64.deb"
- name: "Install golang dependency"
  become: true
  apt:
    name: "golang"
    state: present

- name: "Ensure /etc/step-ca dir exists"
  become: true
  file:
    path: "/etc/step-ca"
    state: directory
    mode: "0755"
    owner: root
    group: root
- name: "Copy password file"
  bcome: true
  copy:
    src: generated-password
    dest: /etc/step-ca/password.txt
    mode: '0600'

- name: "Determine if ca server already initialized"
  stat:
    path: "{{step_path}}"
  register: step_dir
- name: "Init ca server"
  command:
    argv:
      - "/usr/bin/step"
      - "ca"
      - "init"
      - "-name"
      - "playground"
      - "-dns"
      - "localhost,ca-server.michaelasnes.com"
      - "-address"
      - ":443"
      - "-provisioner"
      - "playground-ca-1"
      - "-password-file"
      - "/etc/step-ca/password.txt"
  when: not step_dir.stat.exists
